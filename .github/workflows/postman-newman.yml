- name: Send Slack Notification with Weather Details
env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
run: |
  if [ ! -f results.json ]; then
    echo "âš ï¸ results.json NOT FOUND! Creating default file."
    echo '{"run": {"stats": {"assertions": {"failed": 0}}}}' > results.json
  fi

  # Extract the number of failed assertions
  status=$(jq -r '.run.stats.assertions.failed' results.json)

  # Extract weather details per city
  extract_weather() {
    city_name="$1"
    temp_k=$(jq -r ".run.executions[] | select(.item.name == \"${city_name}\") | .response.stream | fromjson | .main.temp" results.json || echo "N/A")
    humidity=$(jq -r ".run.executions[] | select(.item.name == \"${city_name}\") | .response.stream | fromjson | .main.humidity" results.json || echo "N/A")
    wind_speed=$(jq -r ".run.executions[] | select(.item.name == \"${city_name}\") | .response.stream | fromjson | .wind.speed" results.json || echo "N/A")
    status=$(jq -r ".run.executions[] | select(.item.name == \"${city_name}\") | .assertions[].error" results.json | grep -q "false" && echo "âœ…" || echo "ğŸ›‘")

    # Convert temperature from Kelvin to Celsius
    if [[ "$temp_k" != "N/A" ]]; then
      temp_c=$(echo "scale=2; $temp_k - 273.15" | bc)
    else
      temp_c="N/A"
    fi

    echo "${city_name}: ğŸŒ¡ ${temp_c}Â°C | ğŸ’¨ ${wind_speed} m/s | ğŸ’§ ${humidity}% ${status}"
  }

  london_weather=$(extract_weather "London Weather")
  ny_weather=$(extract_weather "New York Weather")
  la_weather=$(extract_weather "Los Angeles Weather")

  # Build Slack message
  if [ "$status" -gt 0 ]; then
    message="ğŸš¨ *Postman API Test Failed!* âŒ\n
    ğŸ”¹ *Repository:* ${{ github.repository }}\n
    ğŸ”¹ *Workflow:* ${{ github.workflow }}\n
    ğŸ”¹ *Run:* [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n
    ğŸ”¹ *Failed Assertions:* $status âŒ\n
    ${london_weather}\n
    ${ny_weather}\n
    ${la_weather}"
  else
    message="âœ… *All API Tests Passed!* ğŸ‰\n
    ğŸ”¹ *Repository:* ${{ github.repository }}\n
    ğŸ”¹ *Workflow:* ${{ github.workflow }}\n
    ğŸ”¹ *Run:* [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n
    ${london_weather}\n
    ${ny_weather}\n
    ${la_weather}"
  fi
  
  # Send to Slack
  curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$message\"}" $SLACK_WEBHOOK_URL
